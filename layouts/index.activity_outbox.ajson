{{- $pctx := . -}}
{{- if .IsHome -}}{{ $pctx = .Site }}{{- end -}}
{{- $pages := slice -}}
{{- if or $.IsHome $.IsSection -}}
{{- $pages = $pctx.RegularPages -}}
{{- else -}}
{{- $pages = $pctx.Pages -}}
{{- end -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
{{- $pages = $pages | first $limit -}}
{{- end -}}
{
  "@context": "https://www.w3.org/ns/activitystreams",
  "id": "{{ $.Site.BaseURL }}outbox",
  "summary": "{{$.Site.Author.name}} - {{$.Site.Title}}",
  "type": "OrderedCollection",
  {{ $all := where $pages ".Draft" "!=" true }}
  "totalItems": {{(len $all)}},
  "orderedItems": [
  {{ range $index, $element := $all  }}
    {{- if ne $index 0 }}, {{ end }}
    {
      "@context": "https://www.w3.org/ns/activitystreams",
      "id": "{{.Permalink}}-create",
      "type": "Create",
      "actor": "{{ .Site.BaseURL }}{{ site.Params.apUser | lower}}",
      "object": {
        "id": "{{ .Permalink }}",
        "type": "Note",
        "content": {{ printf "\"" | safeHTML }}<b>{{.Title}}</b>{{ if .Summary }}<br>{{ replace (replace .Summary "\n" "<br>") "\r" "" }}{{ end }}<br><br>Read more here:<br><a href='{{.Permalink}}'>{{.Permalink}}</a><br>{{ if .Site.Params.renderArticleHashtags }}{{ if .Params.tags }}{{ range $indexArticleTags, $elementArticleTag := .Params.tags }}{{ if ne $indexArticleTags 0 }} {{ end }}<a href='{{ site.BaseURL }}tags/{{ $elementArticleTag }}' class='mention hashtag' rel='tag'>#<span>{{ $elementArticleTag }}</span></a>{{ end }}{{ end }}{{ end }} {{ if .Site.Params.renderDefaultHashtags }}{{ if .Site.Params.postHashtags }}{{ range $indexTags, $elementTag := .Site.Params.postHashtags }}{{ if ne $indexTags 0 }} {{ end }}#{{ $elementTag }}{{ end }}{{ end }}{{ end }}{{ printf "\"" | safeHTML }},
        "url": "{{.Permalink}}",
        "attributedTo": "{{ .Site.BaseURL }}{{ site.Params.apUser | lower}}",
        "to": "https://www.w3.org/ns/activitystreams#Public",
        {{ if (or (and .Site.Params.postHashtags .Site.Params.renderDefaultHashtags) (and .Params.tags .Site.Params.renderArticleHashtags)) }}
        "tag": [
          {{- if (and .Site.Params.postHashtags .Site.Params.renderDefaultHashtags) }}
          {{- range $indexTags, $elementTag := .Site.Params.postHashtags }}
          {{- if ne $indexTags 0 }}, {{ end }}
          {
            "type": "Hashtag",
            "href": "https://qoto.org/tags/{{ $elementTag }}",
            "name": "#{{ $elementTag }}"
          }
          {{- end }}
          {{- end }}
          {{- $hasTagContent := (and .Site.Params.postHashtags .Site.Params.renderDefaultHashtags) }}
          {{- if (and .Params.tags .Site.Params.renderArticleHashtags) }}
          {{- range $indexTags, $elementTag := .Params.tags }}
          {{- if (or (ne $indexTags 0) $hasTagContent) }}, {{ end }}
          {
            "type": "Hashtag",
            "href": "https://qoto.org/tags/{{ $elementTag }}",
            "name": "#{{ $elementTag }}"
          }
          {{- end }}
          {{- end }}
          ],
        {{- end }}
        "published": {{ dateFormat "2006-01-02T15:04:05-07:00" .Date | jsonify }}
      }
    }
  {{end}}
  ]
}
